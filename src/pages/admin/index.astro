---
import AppHeader from "../../components/AppHeader.astro";
import AppFooter from "../../components/AppFooter.astro";
import "../../styles/base.css";

export const prerender = false;
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Game Club | Admin</title>
	</head>
	<body>
		<AppHeader />

		<main class="admin-shell is-hidden">
			<div class="container">
				<section class="hero">
					<div class="hero-text">
						<p class="eyebrow">Admin</p>
						<h1>Control Room</h1>
						<p class="muted">Manage members, content, and club operations.</p>
					</div>
				</section>

				<section class="section card members-card">
					<div class="section-head">
						<h2>Members</h2>
						<p class="muted">View and manage member access.</p>
					</div>
					<button class="cta invite-cta" type="button" data-action="open-invite">
						Add a new member
					</button>
					<div class="member-list" aria-live="polite">
						<p class="muted small">Loading members…</p>
					</div>
				</section>

				<section class="section card games-editor">
					<div class="section-head">
						<h2>Games data editor</h2>
						<p class="muted">Edit submitters, status, tags, and timing details.</p>
					</div>
					<p class="muted small">Tags: comma-separated list (e.g. Narrative, Roguelike, Puzzle)</p>
					<div class="table-wrapper">
						<table class="games-table games-editor-table">
							<thead>
								<tr>
									<th>Title</th>
									<th>Submitter</th>
									<th>Status</th>
									<th>Tags</th>
									<th>Time to beat (hours)</th>
									<th>Played month</th>
									<th></th>
								</tr>
							</thead>
							<tbody class="games-editor-body">
								<tr>
									<td class="muted small" colspan="7">Loading games…</td>
								</tr>
							</tbody>
						</table>
					</div>
				</section>
			</div>
		</main>
		<AppFooter />

		<dialog class="modal" id="invite-modal">
			<form method="dialog" class="modal-card invite-form" novalidate>
				<header>
					<h3>Add a new member</h3>
					<button class="ghost icon-button" type="button" data-action="close-invite" aria-label="Close">
						×
					</button>
				</header>
				<div class="field">
					<label for="invite-email">Email</label>
					<input id="invite-email" name="email" type="email" placeholder="name@example.com" required />
				</div>
				<div class="field">
					<label for="invite-role">Role</label>
					<select id="invite-role" name="role" required>
						<option value="member" selected>Member</option>
						<option value="admin">Admin</option>
					</select>
				</div>
				<footer>
					<button class="ghost" value="cancel" type="button" data-action="close-invite">Cancel</button>
					<button class="cta" type="submit">Submit</button>
				</footer>
			</form>
		</dialog>

		<dialog class="modal" id="member-modal">
			<form class="modal-card member-detail" novalidate>
				<header>
					<div>
						<h3 id="member-name">Member</h3>
						<p class="muted small" id="member-email">email@example.com</p>
					</div>
					<button class="ghost icon-button" type="button" data-action="close-member" aria-label="Close">
						×
					</button>
				</header>
				<div class="field">
					<label for="edit-role">Role</label>
					<select id="edit-role" name="role" required>
						<option value="member">Member</option>
						<option value="admin">Admin</option>
					</select>
				</div>
				<div class="field">
					<label for="edit-alias">Alias</label>
					<input id="edit-alias" name="alias" type="text" placeholder="Optional" />
				</div>
				<div class="actions">
					<button class="ghost danger small-button" data-action="delete" type="button">Delete member</button>
				</div>
				<footer>
					<button class="ghost" type="button" data-action="close-member">Cancel</button>
					<button class="cta" type="submit">Submit</button>
				</footer>
			</form>
		</dialog>

		<script>
			const shell = document.querySelector(".admin-shell");
			const inviteForm = document.querySelector("#invite-modal .invite-form");
			const memberList = document.querySelector(".member-list");
			const gamesBody = document.querySelector(".games-editor-body");
			const inviteModal = document.querySelector("#invite-modal");
			const memberModal = document.querySelector("#member-modal");
			const memberName = document.querySelector("#member-name");
			const memberEmail = document.querySelector("#member-email");
			const editRole = document.querySelector("#edit-role");
			const editAlias = document.querySelector("#edit-alias");
			let activeMember = null;
			let cachedMembers = [];
			let cachedGames = [];

			let currentUserEmail = null;

			fetch("/api/admin/summary")
				.then((response) => {
					if (response.status === 401) {
						window.location.href = "/api/auth/login";
						throw new Error("Unauthorized");
					}
					if (response.status === 403) {
						window.location.href = "/auth/denied";
						throw new Error("Forbidden");
					}
					return response.json();
				})
				.then((data) => {
					currentUserEmail = data?.me?.email || null;
					if (shell) shell.classList.remove("is-hidden");
					renderMembers(data?.members || []);
					loadGames();
				})
				.catch(() => {});

			function renderMembers(members) {
				if (!memberList) return;
				if (!members || members.length === 0) {
					memberList.innerHTML = '<p class="muted small">No members yet.</p>';
					return;
				}

				cachedMembers = members;
				memberList.innerHTML = '<div class="toast" aria-live="polite"></div>';
				const grid = document.createElement("div");
				grid.className = "member-grid";
				members.forEach((member) => {
					const row = document.createElement("button");
					row.className = "member-row";
					row.type = "button";
					row.dataset.email = member.email;

					const avatar = document.createElement("div");
					avatar.className = "avatar";
					if (member.picture) {
						const img = document.createElement("img");
						img.className = "avatar-img";
						img.src = member.picture;
						img.alt = "";
						img.referrerPolicy = "no-referrer";
						img.decoding = "async";
						avatar.appendChild(img);
					} else {
						const fallback = document.createElement("span");
						fallback.className = "avatar-fallback";
						fallback.textContent = (member.name || member.email)
							.charAt(0)
							.toUpperCase();
						avatar.appendChild(fallback);
					}

					const details = document.createElement("div");
					const name = document.createElement("div");
					name.className = "member-name";
					name.textContent = member.name || "—";
					const email = document.createElement("div");
					email.className = "member-email";
					email.textContent = member.email;
					details.appendChild(name);
					details.appendChild(email);

					const role = document.createElement("span");
					role.className = "role-pill";
					role.textContent = member.role === "admin" ? "Admin" : "Member";

					row.appendChild(avatar);
					row.appendChild(details);
					row.appendChild(role);
					grid.appendChild(row);
				});
				memberList.appendChild(grid);
			}

			async function loadGames() {
				if (!gamesBody) return;
				gamesBody.innerHTML = '<tr><td class="muted small" colspan="7">Loading games…</td></tr>';
				const response = await fetch("/api/admin/games");
				if (!response.ok) {
					gamesBody.innerHTML = '<tr><td class="muted small" colspan="7">Unable to load games.</td></tr>';
					return;
				}
				const games = await response.json();
				cachedGames = games || [];
				renderGames(cachedGames);
			}

			function renderGames(games) {
				if (!gamesBody) return;
				if (!games || games.length === 0) {
					gamesBody.innerHTML = '<tr><td class="muted small" colspan="7">No games yet.</td></tr>';
					return;
				}
				gamesBody.innerHTML = "";
				games.forEach((game) => {
					const row = document.createElement("tr");
					row.dataset.id = game.id;

					const titleCell = document.createElement("td");
					titleCell.textContent = game.title;

					const submitterCell = document.createElement("td");
					const submitterSelect = document.createElement("select");
					submitterSelect.className = "inline-select";
					cachedMembers.forEach((member) => {
						const option = document.createElement("option");
						option.value = member.email;
						const label = member.alias || member.name || member.email;
						option.textContent = label;
						if (member.email === game.submitted_by_email) option.selected = true;
						submitterSelect.appendChild(option);
					});
					submitterCell.appendChild(submitterSelect);

					const statusCell = document.createElement("td");
					const statusSelect = document.createElement("select");
					statusSelect.className = "inline-select";
					["backlog", "current", "played"].forEach((value) => {
						const option = document.createElement("option");
						option.value = value;
						option.textContent = value;
						if (value === game.status) option.selected = true;
						statusSelect.appendChild(option);
					});
					statusCell.appendChild(statusSelect);

					const tagsCell = document.createElement("td");
					const tagsInput = document.createElement("input");
					tagsInput.type = "text";
					tagsInput.className = "inline-input";
					tagsInput.value = game.tags_json ? JSON.parse(game.tags_json).join(", ") : "";
					tagsCell.appendChild(tagsInput);

					const ttbCell = document.createElement("td");
					const ttbInput = document.createElement("input");
					ttbInput.type = "number";
					ttbInput.min = "0";
					ttbInput.step = "0.5";
					ttbInput.className = "inline-input";
					ttbInput.value = typeof game.time_to_beat_minutes === "number"
						? String((game.time_to_beat_minutes / 60).toFixed(1))
						: "";
					ttbCell.appendChild(ttbInput);

					const playedCell = document.createElement("td");
					const playedInput = document.createElement("input");
					playedInput.type = "month";
					playedInput.className = "inline-input";
					playedInput.value = game.played_month || "";
					playedCell.appendChild(playedInput);

					const actionCell = document.createElement("td");
					const saveButton = document.createElement("button");
					saveButton.type = "button";
					saveButton.className = "ghost small-button";
					saveButton.textContent = "Save";
					saveButton.addEventListener("click", async () => {
						const hoursValue = ttbInput.value ? Number.parseFloat(ttbInput.value) : null;
						if (hoursValue !== null && Number.isNaN(hoursValue)) {
							return;
						}
						const payload = {
							id: game.id,
							submitted_by_email: submitterSelect.value,
							status: statusSelect.value,
							tags: tagsInput.value,
							time_to_beat_hours: hoursValue,
							played_month: playedInput.value
						};
						const response = await fetch("/api/admin/games", {
							method: "PATCH",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(payload)
						});
						if (response.ok) {
							loadGames();
						} else {
							showToast("Unable to update game.", true);
						}
					});
					actionCell.appendChild(saveButton);

					row.appendChild(titleCell);
					row.appendChild(submitterCell);
					row.appendChild(statusCell);
					row.appendChild(tagsCell);
					row.appendChild(ttbCell);
					row.appendChild(playedCell);
					row.appendChild(actionCell);
					gamesBody.appendChild(row);
				});
			}

			document.addEventListener("click", (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				const openInvite = target.closest("[data-action='open-invite']");
				if (openInvite && inviteModal) {
					inviteModal.showModal();
				}
				const closeInvite = target.closest("[data-action='close-invite']");
				if (closeInvite && inviteModal) {
					inviteModal.close();
				}
				const closeMember = target.closest("[data-action='close-member']");
				if (closeMember && memberModal) {
					memberModal.close();
				}
				const row = target.closest(".member-row");
				if (row && memberModal) {
					const email = row.dataset.email;
					if (!email) return;
					openMemberModal(email);
				}
			});

			if (inviteForm) {
				inviteForm.addEventListener("submit", async (event) => {
					event.preventDefault();
					const formData = new FormData(inviteForm);
					const email = formData.get("email");
					const role = formData.get("role");
					const response = await fetch("/api/admin/members", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ email, role })
					});
					if (response.ok) {
						inviteForm.reset();
						if (inviteModal) inviteModal.close();
						loadMembers();
					}
				});
			}

			async function loadMembers() {
				if (!memberList) return;
				memberList.innerHTML = '<p class="muted small">Loading members…</p>';
				const response = await fetch("/api/admin/members");
				if (!response.ok) {
					memberList.innerHTML = '<p class="muted small">Unable to load members.</p>';
					return;
				}
				const members = await response.json();
				renderMembers(members);
			}

			function openMemberModal(email) {
				activeMember = email;
				const row = document.querySelector(`.member-row[data-email="${email}"]`);
				if (!row || !memberModal) return;
				const name = row.querySelector(".member-name")?.textContent || "Member";
				if (memberName) memberName.textContent = name;
				if (memberEmail) memberEmail.textContent = email;
				memberModal.showModal();
				loadMemberDetail(email);
			}

			async function loadMemberDetail(email) {
				const member = cachedMembers.find((item) => item.email === email);
				if (!member) return;
				if (editRole) editRole.value = member.role;
				if (editAlias) editAlias.value = member.alias || "";
				const isSelf = currentUserEmail && member.email === currentUserEmail;
				if (editRole) editRole.disabled = isSelf;
				const deleteButton = memberModal?.querySelector("[data-action='delete']");
				if (deleteButton) deleteButton.disabled = isSelf;
			}

			if (memberModal) {
				memberModal.addEventListener("submit", async (event) => {
					event.preventDefault();
					if (!activeMember) return;
					const isSelf = currentUserEmail && activeMember === currentUserEmail;
					const payload = {
						email: activeMember,
						alias: editAlias?.value || ""
					};
					if (!isSelf) {
						payload.role = editRole?.value || "member";
					}
					const response = await fetch("/api/admin/members", {
						method: "PATCH",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(payload)
					});
					if (response.ok) {
						showToast("Member updated.");
						memberModal.close();
						loadMembers();
					} else {
						showToast("Unable to update member.", true);
					}
				});

				memberModal.addEventListener("click", async (event) => {
					const target = event.target;
					if (!(target instanceof HTMLElement)) return;
					const action = target.dataset.action;
					if (action === "delete" && activeMember) {
						const confirmed = window.confirm("Delete this member? This cannot be undone.");
						if (!confirmed) return;
						await fetch("/api/admin/members", {
							method: "DELETE",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ email: activeMember })
						});
						memberModal.close();
						loadMembers();
					}
				});
			}

			function showToast(message, isError = false) {
				const toast = document.querySelector(".toast");
				if (!toast) return;
				toast.textContent = message;
				toast.classList.toggle("is-error", isError);
				toast.classList.add("is-visible");
				setTimeout(() => {
					toast.classList.remove("is-visible");
				}, 2000);
			}
		</script>
	</body>
</html>

<style>
	:root {
		color-scheme: light;
		--ink: #1f2933;
		--muted: #5b6672;
		--tan: #dbe2ea;
		--ink-soft: #364152;
		--shadow: rgba(13, 30, 48, 0.18);
		--border: rgba(33, 51, 70, 0.14);
		--accent: #3b6ea5;
		--accent-dark: #2a5581;
		--radius: 22px;
		--glass: rgba(255, 255, 255, 0.7);
		--glass-strong: rgba(255, 255, 255, 0.88);
		font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
		background: radial-gradient(circle at top right, #f7fbff 0%, #eef2f6 55%, #e2e8f0 100%);
	}

	* {
		box-sizing: border-box;
	}

	body {
		margin: 0;
		color: var(--ink);
		background: linear-gradient(120deg, #f6f9fc 0%, #e9eff6 60%, #dde5ef 100%);
		min-height: 100vh;
	}

	main {
		display: grid;
		gap: 2rem;
	}

	.hero {
		display: grid;
		gap: 0;
		max-width: 520px;
	}

.hero .muted {
	max-width: 34rem;
}

	.members-card {
		max-width: 600px;
	}

	.invite-form {
		display: grid;
		gap: 1rem;
	}


	.member-list {
		display: grid;
		gap: 0.6rem;
	}

	:global(.member-grid) {
		display: grid;
		gap: 0.8rem;
	}

	:global(.member-row) {
		appearance: none;
		border: none;
		display: grid;
		grid-template-columns: auto 1fr auto;
		align-items: center;
		gap: 1rem;
		padding: 0.9rem 1.1rem;
		border-radius: 16px;
		border: 1px solid var(--border);
		background: var(--glass-strong);
		text-align: left;
		cursor: pointer;
		width: 100%;
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

	:global(.member-row:hover) {
		transform: translateY(-1px);
		box-shadow: 0 18px 36px -30px var(--shadow);
	}

	:global(.avatar) {
		width: 40px;
		height: 40px;
		border-radius: 50%;
		background: rgba(59, 110, 165, 0.18);
		display: grid;
		place-items: center;
		font-weight: 700;
		color: var(--ink-soft);
		overflow: hidden;
	}

	:global(.avatar-img) {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	:global(.avatar-fallback) {
		display: grid;
		place-items: center;
		width: 100%;
		height: 100%;
	}

	:global(.role-pill) {
		padding: 0.25rem 0.7rem;
		border-radius: 999px;
		border: 1px solid var(--border);
		font-size: 0.75rem;
		background: rgba(255, 255, 255, 0.7);
	}

		:global(.toast) {
			margin-bottom: 0;
		padding: 0.4rem 0.8rem;
		border-radius: 999px;
		font-size: 0.8rem;
		background: rgba(43, 177, 120, 0.2);
		color: #1b6346;
		border: 1px solid rgba(43, 177, 120, 0.4);
		display: inline-flex;
		align-items: center;
		gap: 0.4rem;
		opacity: 0;
		transform: translateY(-4px);
		transition: opacity 0.2s ease, transform 0.2s ease;
	}

		:global(.toast.is-visible) {
			opacity: 1;
			transform: translateY(0);
			margin-bottom: 0.6rem;
		}

	:global(.toast.is-error) {
		background: rgba(200, 90, 90, 0.18);
		color: #8a2f2f;
		border-color: rgba(200, 90, 90, 0.4);
	}

	.member-name {
		font-weight: 600;
	}

	.member-email {
		color: var(--muted);
		font-size: 0.82rem;
	}

	.switch {
		display: inline-flex;
		align-items: center;
		gap: 0.6rem;
		font-weight: 600;
		font-size: 0.85rem;
	}

	.switch input {
		display: none;
	}

	.switch .slider {
		position: relative;
		width: 38px;
		height: 20px;
		background: rgba(33, 51, 70, 0.18);
		border-radius: 999px;
		transition: background 0.2s ease;
	}

	.switch .slider::before {
		content: "";
		position: absolute;
		top: 2px;
		left: 2px;
		width: 16px;
		height: 16px;
		background: #fff;
		border-radius: 50%;
		transition: transform 0.2s ease;
		box-shadow: 0 4px 8px rgba(31, 41, 51, 0.25);
	}

	.switch input:checked + .slider {
		background: rgba(59, 110, 165, 0.7);
	}

	.switch input:checked + .slider::before {
		transform: translateX(18px);
	}

	.switch-label {
		color: var(--ink-soft);
	}

	.status {
		display: inline-flex;
		align-items: center;
		padding: 0.2rem 0.6rem;
		border-radius: 999px;
		font-size: 0.75rem;
		background: rgba(255, 255, 255, 0.6);
		border: 1px solid var(--border);
	}

	.status-active {
		color: #1b6346;
		background: rgba(43, 177, 120, 0.15);
		border-color: rgba(43, 177, 120, 0.4);
	}

	.status-disabled {
		color: #7a4c4c;
		background: rgba(200, 90, 90, 0.12);
		border-color: rgba(200, 90, 90, 0.4);
	}

	.actions {
		display: flex;
		gap: 0.5rem;
		flex-wrap: wrap;
	}

	.small-button {
		padding: 0.4rem 0.7rem;
		font-size: 0.75rem;
	}

	.ghost.danger {
		border-color: rgba(200, 90, 90, 0.5);
		color: #8a2f2f;
	}

	.actions {
		display: flex;
		gap: 0.6rem;
		flex-wrap: wrap;
	}

	.chip {
		border-radius: 999px;
		padding: 0.4rem 0.85rem;
		font-size: 0.75rem;
		background: var(--tan);
		font-weight: 500;
	}

		.invite-cta {
			width: fit-content;
		}

	.toggle-row {
		display: grid;
		gap: 0.8rem;
	}

	.switch input:disabled + .slider {
		opacity: 0.5;
		cursor: not-allowed;
	}

	@media (max-width: 900px) {
		.invite-form {
			grid-template-columns: 1fr;
		}

		.actions {
			flex-direction: column;
			align-items: flex-start;
		}
	}

	.is-hidden {
		display: none;
	}

	.games-editor-table select,
	.games-editor-table input {
		font-size: 0.85rem;
	}
</style>
