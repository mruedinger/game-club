---
import AppHeader from "../components/AppHeader.astro";
import "../styles/base.css";

type Game = {
	id: number;
	title: string;
	status: "backlog" | "current" | "played";
	tags_json?: string;
	played_month?: string;
	cover_art_url?: string;
	description?: string;
	submitted_by_email?: string;
	submitted_by_name?: string;
	submitted_by_alias?: string;
	steam_app_id?: number;
	itad_slug?: string;
	current_price_cents?: number;
	best_price_cents?: number;
};

const gamesResponse = await fetch(new URL("/api/games", Astro.url), {
	headers: Astro.request.headers
});
const games = gamesResponse.ok
	? await gamesResponse.json()
	: { current: [] };
const currentGame = (games.current as Game[])[0] ?? null;

const sampleGames = [
	{ title: "Outer Wilds", tags: ["Exploration", "Puzzle", "Narrative"], length: "16-22 hrs" },
	{ title: "Hades", tags: ["Roguelike", "Action"], length: "20-30 hrs" },
	{ title: "Return of the Obra Dinn", tags: ["Mystery", "Puzzle"], length: "10-12 hrs" },
	{ title: "Chants of Sennaar", tags: ["Puzzle", "Adventure"], length: "8-12 hrs" },
	{ title: "Pentiment", tags: ["Narrative", "RPG"], length: "15-20 hrs" },
	{ title: "Celeste", tags: ["Platformer", "Indie"], length: "10-15 hrs" }
];

function formatMonthYear(value?: string) {
	if (!value) return "Month TBD";
	const [year, month] = value.split("-");
	if (!year || !month) return value;
	const date = new Date(Number(year), Number(month) - 1, 1);
	return date.toLocaleString("en-US", { month: "long", year: "numeric" });
}
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="generator" content={Astro.generator} />
		<meta
			name="description"
			content="Invite-only video game club."
		/>
		<title>Game Club</title>
	</head>
	<body>
		<AppHeader />

		<main>
			<section class="hero two-column">
				<div class="hero-text">
					<p class="eyebrow">Monthly(ish) Video Game Club</p>
					<h1>A Shindigging good time.</h1>
					<p class="lead">Next meeting Tuesday February 3rd @ 8:15</p>
				</div>
				<div class="hero-card">
					<h2>Current game</h2>
					<p class="muted">{formatMonthYear(currentGame?.played_month)}</p>
					{currentGame ? (
						<div class="games-grid">
							<article
								class="game-card"
								data-id={currentGame.id}
								data-title={currentGame.title}
								data-tags={currentGame.tags_json || ""}
								data-description={currentGame.description || ""}
								data-cover={currentGame.cover_art_url || ""}
								data-submitted={currentGame.submitted_by_email || ""}
								data-submitted-name={currentGame.submitted_by_name || ""}
								data-submitted-alias={currentGame.submitted_by_alias || ""}
								data-steam-app-id={
									currentGame.steam_app_id ? String(currentGame.steam_app_id) : ""
								}
								data-itad-slug={currentGame.itad_slug || ""}
								data-current-price={
									typeof currentGame.current_price_cents === "number"
										? String(currentGame.current_price_cents)
										: ""
								}
								data-best-price={
									typeof currentGame.best_price_cents === "number"
										? String(currentGame.best_price_cents)
										: ""
								}
								data-status={currentGame.status}
							>
								<h3>{currentGame.title}</h3>
								<div class="game-cover">
									{currentGame.cover_art_url ? (
										<img
											src={currentGame.cover_art_url}
											alt={`${currentGame.title} cover art`}
											loading="lazy"
										/>
									) : (
										<div class="cover-placeholder">Cover coming soon</div>
									)}
								</div>
								<p class="muted">
									{currentGame.tags_json
										? JSON.parse(currentGame.tags_json).join(" · ")
										: "Tags coming soon"}
								</p>
							</article>
						</div>
					) : (
						<p class="muted">No current game set yet.</p>
					)}
				</div>
			</section>

			<section id="now" class="section current">
				<div class="section-head">
					<h2>Current game</h2>
					<p>January pick. Playtime target: 4-6 weeks.</p>
				</div>
				<div class="current-card">
					<div>
						<h3>Outer Wilds</h3>
						<p class="muted">
							Explore a handcrafted solar system of secrets, time loops, and cosmic
							discovery.
						</p>
						<div class="chips">
							<span class="chip">Exploration</span>
							<span class="chip">Puzzle</span>
							<span class="chip">16-22 hrs</span>
						</div>
					</div>
					<div class="current-meta">
						<div>
							<span class="label">Status</span>
							<p>Midway check-in</p>
						</div>
						<div>
							<span class="label">Discussion</span>
							<p>Feb 22</p>
						</div>
						<div>
							<span class="label">Next poll</span>
							<p>Opens Feb 10</p>
						</div>
					</div>
				</div>
			</section>

			<section id="poll" class="section poll">
				<div class="section-head">
					<h2>Active poll</h2>
					<p>Vote for up to three games. Equal weight for now.</p>
				</div>
				<div class="poll-card">
					<div class="poll-status">
						<span class="chip strong">Open</span>
						<p class="muted">8 of 10 members voted</p>
					</div>
					<div class="poll-grid">
						{sampleGames.slice(0, 4).map((game, index) => (
							<div class="poll-option" style={`animation-delay: ${index * 80}ms`}>
								<h3>{game.title}</h3>
								<p class="muted">{game.tags.join(" · ")}</p>
							</div>
						))}
					</div>
					<div class="poll-actions">
						<a class="cta" href="#">Cast votes</a>
						<a class="ghost" href="#">Close poll</a>
					</div>
				</div>
			</section>

		</main>

		<dialog class="modal" id="game-detail-modal">
			<form class="modal-card game-detail-card" method="dialog">
				<header>
					<h3 class="game-detail-title">Game details</h3>
					<button class="ghost icon-button" type="button" data-action="close-game-detail" aria-label="Close">
						×
					</button>
				</header>
				<div class="game-detail-body">
					<img class="game-detail-cover" alt="" />
					<div class="game-detail-info">
						<p class="muted game-detail-tags"></p>
						<p class="game-detail-description"></p>
						<div class="game-detail-links">
							<a class="ghost small-pill game-detail-steam" target="_blank" rel="noreferrer" title="View on Steam">Steam</a>
							<a class="ghost small-pill game-detail-hltb" target="_blank" rel="noreferrer" title="View on HowLongToBeat">HLTB</a>
							<a class="ghost small-pill game-detail-itad" target="_blank" rel="noreferrer" title="View on IsThereAnyDeal">ITAD</a>
						</div>
						<div class="game-detail-prices">
							<span class="chip subtle game-detail-current">Current: TBD</span>
							<span class="chip subtle game-detail-best">Best: TBD</span>
						</div>
						<p class="muted small game-detail-submitted"></p>
					</div>
				</div>
				<footer class="game-detail-footer">
					<button class="ghost" type="button" data-action="close-game-detail">Close</button>
					<button class="ghost game-detail-set-current hidden" type="button">Set current</button>
					<button class="ghost danger game-detail-delete hidden" type="button">Delete</button>
				</footer>
			</form>
		</dialog>

		<script>
			const detailModal = document.querySelector("#game-detail-modal");
			const detailTitle = document.querySelector(".game-detail-title");
			const detailTags = document.querySelector(".game-detail-tags");
			const detailDescription = document.querySelector(".game-detail-description");
			const detailSubmitted = document.querySelector(".game-detail-submitted");
			const detailCover = document.querySelector(".game-detail-cover");
			const detailDelete = document.querySelector(".game-detail-delete");
			const detailSetCurrent = document.querySelector(".game-detail-set-current");
			const detailSteam = document.querySelector(".game-detail-steam");
			const detailHltb = document.querySelector(".game-detail-hltb");
			const detailItad = document.querySelector(".game-detail-itad");
			const detailCurrent = document.querySelector(".game-detail-current");
			const detailBest = document.querySelector(".game-detail-best");
			let selectedGameId = null;
			let currentUserEmail = "";
			let currentUserRole = "";
			let isSignedIn = false;

			fetch("/api/me")
				.then((response) => {
					if (!response.ok) throw new Error("Not authenticated");
					isSignedIn = true;
					return response.json();
				})
				.then((data) => {
					if (data?.email) currentUserEmail = String(data.email).toLowerCase();
					if (data?.role) currentUserRole = String(data.role);
				})
				.catch(() => {});

			document.addEventListener("click", (event) => {
				const target = event.target;
				if (!(target instanceof HTMLElement)) return;
				if (target.closest("[data-action='close-game-detail']")) {
					detailModal?.close();
				}
				const card = target.closest(".game-card");
				if (card && detailModal) {
					openGameDetail(card);
				}
			});

			if (detailDelete) {
				detailDelete.addEventListener("click", async () => {
					if (!selectedGameId) return;
					const response = await fetch("/api/games", {
						method: "DELETE",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ id: selectedGameId })
					});
					if (response.ok) {
						detailModal?.close();
						window.location.reload();
					}
				});
			}

			if (detailSetCurrent) {
				detailSetCurrent.addEventListener("click", async () => {
					if (!selectedGameId) return;
					const response = await fetch("/api/games", {
						method: "PATCH",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ id: selectedGameId, action: "set-current" })
					});
					if (response.ok) {
						detailModal?.close();
						window.location.reload();
					}
				});
			}

			function openGameDetail(card) {
				if (!detailModal) return;
				const title = card.dataset.title || "Untitled game";
				const description = card.dataset.description || "Description coming soon.";
				const tags = card.dataset.tags ? parseTags(card.dataset.tags) : "Tags coming soon";
				const submitted = card.dataset.submitted || "";
				const submittedName = card.dataset.submittedName || "";
				const submittedAlias = card.dataset.submittedAlias || "";
				const cover = card.dataset.cover || "";
				const steamAppId = card.dataset.steamAppId || "";
				const itadSlug = card.dataset.itadSlug || "";
				const currentPrice = card.dataset.currentPrice || "";
				const bestPrice = card.dataset.bestPrice || "";
				const status = card.dataset.status || "";
				selectedGameId = card.dataset.id || null;

				if (detailTitle) detailTitle.textContent = title;
				if (detailDescription) detailDescription.textContent = description;
				if (detailTags) detailTags.textContent = tags;
				if (detailSubmitted) {
					const submitter =
						submittedAlias || submittedName || submitted || "a member";
					detailSubmitted.textContent = `Submitted by ${submitter}`;
				}
				if (detailCover) {
					if (cover) {
						detailCover.src = cover;
						detailCover.alt = title;
						detailCover.classList.remove("hidden");
					} else {
						detailCover.removeAttribute("src");
						detailCover.alt = "";
						detailCover.classList.add("hidden");
					}
				}
				if (detailSteam) {
					const steamUrl = steamAppId
						? `https://store.steampowered.com/app/${steamAppId}`
						: "";
					detailSteam.href = steamUrl;
					detailSteam.classList.toggle("hidden", !steamUrl);
				}
				if (detailHltb) {
					const hltbUrl = `https://howlongtobeat.com/?q=${encodeURIComponent(title)}`;
					detailHltb.href = hltbUrl;
					detailHltb.classList.toggle("hidden", !title);
				}
				if (detailItad) {
					const itadUrl = itadSlug
						? `https://isthereanydeal.com/game/${itadSlug}/info/`
						: "";
					detailItad.href = itadUrl;
					detailItad.classList.toggle("hidden", !itadUrl);
				}
				if (detailCurrent) {
					detailCurrent.textContent = currentPrice
						? `Current: ${formatUsd(currentPrice)}`
						: "Current: TBD";
				}
				if (detailBest) {
					detailBest.textContent = bestPrice
						? `Best: ${formatUsd(bestPrice)}`
						: "Best: TBD";
				}
				if (detailDelete) {
					detailDelete.classList.toggle("hidden", !isSignedIn);
					if (isSignedIn) {
						const isOwner =
							submitted && currentUserEmail && submitted.toLowerCase() === currentUserEmail;
						const isAdmin = currentUserRole === "admin";
						const canDelete = isOwner || isAdmin;
						detailDelete.disabled = !canDelete;
					}
				}
				if (detailSetCurrent) {
					const isAdmin = currentUserRole === "admin";
					detailSetCurrent.classList.toggle("hidden", !isAdmin);
					detailSetCurrent.disabled = status === "current";
				}

				detailModal.showModal();
			}

			function parseTags(value) {
				try {
					const parsed = JSON.parse(value);
					if (Array.isArray(parsed)) {
						return parsed.join(" · ");
					}
				} catch {}
				return value;
			}

			function formatUsd(value) {
				const cents = Number.parseInt(value, 10);
				if (Number.isNaN(cents)) return "TBD";
				return new Intl.NumberFormat("en-US", {
					style: "currency",
					currency: "USD"
				}).format(cents / 100);
			}
		</script>

		<footer class="site-footer">
			<p>Invite-only. Built for thoughtful gaming and shared curiosity.</p>
			<div class="footer-actions">
				<a href="#poll">Check poll</a>
			</div>
		</footer>
	</body>
</html>

<style>
	:root {
		color-scheme: light;
		--ink: #1f2933;
		--muted: #5b6672;
		--cream: #eef2f6;
		--tan: #dbe2ea;
		--sun: #8bb5e1;
		--ink-soft: #364152;
		--shadow: rgba(13, 30, 48, 0.18);
		--border: rgba(33, 51, 70, 0.14);
		--accent: #3b6ea5;
		--accent-dark: #2a5581;
		--radius: 22px;
		font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
		background: radial-gradient(circle at top right, #f7fbff 0%, #eef2f6 55%, #e2e8f0 100%);
	}

	* {
		box-sizing: border-box;
	}

	body {
		margin: 0;
		color: var(--ink);
		background: linear-gradient(120deg, #f6f9fc 0%, #e9eff6 60%, #dde5ef 100%);
		min-height: 100vh;
		position: relative;
	}

	body::before {
		content: "";
		position: fixed;
		inset: 0;
		background: radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.7) 0%, transparent 55%),
			radial-gradient(circle at 80% 10%, rgba(143, 179, 220, 0.4) 0%, transparent 50%),
			linear-gradient(160deg, rgba(255, 255, 255, 0.5) 0%, transparent 60%);
		pointer-events: none;
		z-index: -1;
	}

	a {
		color: inherit;
		text-decoration: none;
	}

	.hero {
		display: grid;
		gap: 2rem;
		grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
	}

	.hero-card,
	.current-card,
	.poll-card {
		background: rgba(255, 255, 255, 0.78);
		border-radius: var(--radius);
		padding: 1.8rem;
		box-shadow: 0 24px 50px -30px var(--shadow);
		border: 1px solid var(--border);
	}


	.stack {
		display: grid;
		gap: 0.6rem;
		margin-top: 1rem;
	}

	.stack-item {
		padding: 0.6rem 0.9rem;
		border-radius: 12px;
		background: var(--tan);
		font-weight: 500;
	}

	.section {
		margin-top: 4rem;
	}

	.section-head {
		display: flex;
		align-items: baseline;
		justify-content: space-between;
		gap: 2rem;
		margin-bottom: 1.5rem;
		flex-wrap: wrap;
	}

	.section-head p {
		color: var(--muted);
		max-width: 30rem;
	}

	.current-card {
		display: grid;
		grid-template-columns: minmax(240px, 1.4fr) minmax(200px, 1fr);
		gap: 2rem;
	}

	.current-meta {
		display: grid;
		gap: 1rem;
	}

	.label {
		text-transform: uppercase;
		font-size: 0.7rem;
		letter-spacing: 0.18em;
		color: var(--muted);
		font-weight: 600;
	}

	.chips {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
	}

	.poll-card {
		display: grid;
		gap: 1.5rem;
	}

	.poll-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1rem;
	}

	.poll-option,
	.played-card {
		padding: 1.2rem;
		border-radius: 18px;
		border: 1px solid var(--border);
		background: rgba(255, 255, 255, 0.72);
		animation: rise 0.5s ease both;
	}

	.games-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
		gap: 1.2rem;
	}

	.played-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1rem;
	}

	.site-footer {
		padding: 2rem 6vw 3rem;
		border-top: 1px solid var(--border);
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 1.5rem;
		flex-wrap: wrap;
		background: rgba(238, 242, 246, 0.85);
	}

	.footer-actions {
		display: flex;
		gap: 1rem;
	}

	@media (max-width: 900px) {
		.site-header {
			flex-direction: column;
			gap: 1rem;
		}

		.site-nav {
			flex-wrap: wrap;
			justify-content: center;
		}

		.current-card {
			grid-template-columns: 1fr;
		}
	}

	@media (max-width: 600px) {
		.header-actions {
			width: 100%;
			justify-content: center;
			flex-wrap: wrap;
		}

		.section-head {
			flex-direction: column;
			align-items: flex-start;
		}
	}

	@keyframes rise {
		from {
			opacity: 0;
			transform: translateY(12px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	@media (prefers-reduced-motion: reduce) {
		* {
			animation: none !important;
			transition: none !important;
		}
	}
</style>
