<header class="site-header">
	<a class="brand" href="/">
		<span class="brand-mark">GC</span>
		<span>Game Club</span>
	</a>
	<nav class="site-nav">
		<a href="/">Home</a>
		<a href="/games">Games</a>
		<a class="admin-link" href="/admin">Admin</a>
	</nav>
	<div class="header-actions">
		<div class="user-placeholder" title="Not signed in" aria-hidden="true">
			<span class="avatar-fallback">ðŸ‘¤</span>
		</div>
		<button class="user-button" type="button" aria-label="User menu"></button>
		<a class="ghost auth-signin" href="/api/auth/login">Sign in</a>
		<button class="ghost auth-signout" type="button">Sign out</button>
	</div>
</header>

<dialog class="modal" id="user-modal">
	<form class="modal-card user-detail" novalidate>
		<header>
			<div>
				<h3 id="user-name">Member</h3>
				<p class="muted small" id="user-email">email@example.com</p>
				<p class="muted small" id="user-role">Member</p>
			</div>
			<button class="ghost icon-button" type="button" data-action="close-user" aria-label="Close">
				Ã—
			</button>
		</header>
		<div class="field">
			<label for="user-alias">Alias</label>
			<input id="user-alias" name="alias" type="text" placeholder="Optional" />
		</div>
		<footer>
			<button class="ghost" type="button" data-action="close-user">Cancel</button>
			<button class="cta" type="submit">Save</button>
		</footer>
	</form>
</dialog>

<script>
	const signIn = document.querySelector(".auth-signin");
	const signOut = document.querySelector(".auth-signout");
	const adminLink = document.querySelector(".admin-link");
	const userButton = document.querySelector(".user-button");
	const userModal = document.querySelector("#user-modal");
	const userName = document.querySelector("#user-name");
	const userEmail = document.querySelector("#user-email");
	const userRole = document.querySelector("#user-role");
	const userAlias = document.querySelector("#user-alias");
	let currentUser = null;

	if (adminLink) adminLink.style.display = "none";
	if (userButton) userButton.style.display = "none";
	if (signOut) signOut.style.display = "none";
	const placeholder = document.querySelector(".user-placeholder");
	if (placeholder) placeholder.style.display = "inline-flex";

	fetch("/api/me")
		.then((response) => {
			if (!response.ok) throw new Error("Not authenticated");
			return response.json();
		})
		.then((data) => {
			currentUser = data;
			if (signIn) signIn.style.display = "none";
			if (userButton) userButton.style.display = "inline-flex";
			if (signOut) signOut.style.display = "inline-flex";
			if (placeholder) placeholder.style.display = "none";
			if (adminLink && data.role === "admin") adminLink.style.display = "inline-flex";

			if (userName) userName.textContent = data.name || data.alias || data.email;
			if (userEmail) userEmail.textContent = data.email;
			if (userRole) userRole.textContent = data.role === "admin" ? "Admin" : "Member";
			if (userAlias) userAlias.value = data.alias || "";
			if (userButton) {
				const displayName = data.alias || data.name || data.email;
				userButton.title = `${data.role === "admin" ? "Admin" : "Member"}\n${displayName}\n${data.email}`;
			}

			if (userButton) {
				userButton.textContent = "";
				if (data.picture) {
					const img = document.createElement("img");
					img.className = "avatar-img";
					img.src = data.picture;
					img.alt = "";
					img.referrerPolicy = "no-referrer";
					img.decoding = "async";
					img.width = 32;
					img.height = 32;
					img.style.width = "32px";
					img.style.height = "32px";
					img.style.borderRadius = "50%";
					userButton.appendChild(img);
				} else {
					const fallback = document.createElement("span");
					fallback.className = "avatar-fallback";
					fallback.textContent = (data.name || data.email).charAt(0).toUpperCase();
					userButton.appendChild(fallback);
				}
			}
		})
		.catch(() => {});

	document.addEventListener("click", (event) => {
		const target = event.target;
		if (!(target instanceof HTMLElement)) return;
		if (target.closest(".user-button") && userModal) {
			userModal.showModal();
		}
		if (target.closest("[data-action='close-user']") && userModal) {
			userModal.close();
		}
		if (target.closest(".auth-signout")) {
			fetch("/api/auth/logout", { method: "POST" }).then(() => {
				window.location.href = "/";
			});
		}
	});

	if (userModal) {
		userModal.addEventListener("submit", async (event) => {
			event.preventDefault();
			if (!currentUser) return;
			const response = await fetch("/api/me", {
				method: "PATCH",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ alias: userAlias?.value || "" })
			});
			if (response.ok) {
				if (userModal) userModal.close();
				window.location.reload();
			}
		});
	}
</script>

<style>
	.site-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 1.5rem 5vw 1rem;
		position: sticky;
		top: 0;
		background: rgba(238, 242, 246, 0.9);
		backdrop-filter: blur(14px);
		z-index: 10;
		border-bottom: 1px solid rgba(33, 51, 70, 0.14);
	}

	.brand {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		font-weight: 600;
		letter-spacing: 0.02em;
		color: inherit;
		text-decoration: none;
	}

	.brand-mark {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 42px;
		height: 42px;
		border-radius: 14px;
		background: #1f2933;
		color: #e9f2fb;
		font-weight: 700;
	}

	.site-nav {
		display: flex;
		gap: 1.5rem;
		font-size: 0.95rem;
	}

	.site-nav a {
		color: #364152;
		text-decoration: none;
	}

	.header-actions {
		display: flex;
		gap: 0.8rem;
		align-items: center;
	}


	.user-button {
		width: 32px;
		height: 32px;
		min-width: 32px;
		min-height: 32px;
		border-radius: 50%;
		border: 1px solid rgba(33, 51, 70, 0.14);
		background: rgba(255, 255, 255, 0.8);
		display: inline-flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		padding: 0;
		overflow: hidden;
	}

	.user-placeholder {
		width: 32px;
		height: 32px;
		border-radius: 50%;
		border: 1px solid rgba(33, 51, 70, 0.14);
		background: rgba(255, 255, 255, 0.8);
		display: inline-flex;
		align-items: center;
		justify-content: center;
	}

	.user-placeholder .avatar-fallback {
		color: #8a97a3;
		font-size: 0.9rem;
	}

	.avatar-img {
		width: 100%;
		height: 100%;
		border-radius: 50%;
		object-fit: cover;
		display: block;
	}

	.avatar-fallback {
		font-weight: 700;
		color: #364152;
		width: 100%;
		height: 100%;
		display: grid;
		place-items: center;
	}

	.modal-card footer {
		justify-content: space-between;
		align-items: center;
		flex-wrap: wrap;
	}

	.footer-actions {
		display: flex;
		gap: 0.8rem;
		align-items: center;
	}

	.cta {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 0.7rem 1.4rem;
		border-radius: 999px;
		font-weight: 600;
		font-size: 0.9rem;
		background: #3b6ea5;
		color: #fff;
		border: none;
		box-shadow: 0 12px 20px -16px #2a5581;
		cursor: pointer;
	}

	.field {
		display: grid;
		gap: 0.3rem;
	}

	label {
		font-weight: 600;
		font-size: 0.85rem;
		color: #364152;
	}

	input {
		width: 100%;
		max-width: 100%;
		box-sizing: border-box;
		border-radius: 12px;
		border: 1px solid rgba(33, 51, 70, 0.14);
		padding: 0.65rem 0.9rem;
		font-size: 0.9rem;
		font-family: inherit;
		background: rgba(255, 255, 255, 0.8);
	}


	.muted {
		color: #5b6672;
		line-height: 1.6;
	}

	.small {
		font-size: 0.9rem;
	}

	@media (max-width: 900px) {
		.site-header {
			flex-direction: column;
			gap: 1rem;
		}

		.site-nav {
			flex-wrap: wrap;
			justify-content: center;
		}
	}
</style>
