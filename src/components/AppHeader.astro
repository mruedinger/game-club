---
type HeaderUser = {
	email: string;
	name?: string;
	alias?: string;
	picture?: string;
	role: "admin" | "member";
};

const initialUser = (Astro.props.initialUser ?? null) as HeaderUser | null;
---

<header class="site-header">
	<a class="brand" href="/">
		<span class="brand-mark">GC</span>
		<span>Game Club</span>
	</a>
	<nav class="site-nav">
		<a href="/">Home</a>
		<a class="admin-link" href="/admin">Admin</a>
	</nav>
	<div class="header-actions">
		<div class="user-placeholder" title="Not signed in" aria-hidden="true">
			<span class="avatar-fallback">ðŸ‘¤</span>
		</div>
		<button class="user-button" type="button" aria-label="User menu"></button>
		<a class="ghost auth-signin" href="/api/auth/login">Sign in</a>
		<button class="ghost auth-signout" type="button">Sign out</button>
	</div>
</header>

<dialog class="modal" id="user-modal">
	<form class="modal-card user-detail" novalidate>
		<header>
			<div>
				<h3 id="user-name">Member</h3>
				<p class="muted small" id="user-email">email@example.com</p>
				<p class="muted small" id="user-role">Member</p>
			</div>
			<button class="ghost icon-button" type="button" data-action="close-user" aria-label="Close">
				Ã—
			</button>
		</header>
		<div class="field">
			<label for="user-alias">Alias</label>
			<input id="user-alias" name="alias" type="text" placeholder="Optional" />
		</div>
		<p class="form-error hidden" id="user-modal-error" role="alert"></p>
		<footer>
			<button class="ghost" type="button" data-action="close-user">Cancel</button>
			<button class="cta" type="submit">Save</button>
		</footer>
	</form>
</dialog>

<script define:vars={{ initialUser }}>
	const signIn = document.querySelector(".auth-signin");
	const signOut = document.querySelector(".auth-signout");
	const adminLink = document.querySelector(".admin-link");
	const userButton = document.querySelector(".user-button");
	const userModal = document.querySelector("#user-modal");
	const userName = document.querySelector("#user-name");
	const userEmail = document.querySelector("#user-email");
	const userRole = document.querySelector("#user-role");
	const userAlias = document.querySelector("#user-alias");
	const userModalError = document.querySelector("#user-modal-error");
	let currentUser = initialUser || null;
	const placeholder = document.querySelector(".user-placeholder");

	function firstName(value) {
		if (!value) return "";
		return String(value).trim().split(/\s+/)[0] || "";
	}

	function displayName(user) {
		return user.alias || firstName(user.name) || "Member";
	}

	function applySignedOutState() {
		currentUser = null;
		if (adminLink) adminLink.style.display = "none";
		if (userButton) userButton.style.display = "none";
		if (signOut) signOut.style.display = "none";
		if (signIn) signIn.style.display = "inline-flex";
		if (placeholder) placeholder.style.display = "inline-flex";
	}

	function applySignedInState(data) {
		currentUser = data;
		if (signIn) signIn.style.display = "none";
		if (userButton) userButton.style.display = "inline-flex";
		if (signOut) signOut.style.display = "inline-flex";
		if (placeholder) placeholder.style.display = "none";
		if (adminLink) {
			adminLink.style.display = data.role === "admin" ? "inline-flex" : "none";
		}
		if (userName) userName.textContent = displayName(data);
		if (userEmail) userEmail.textContent = data.email;
		if (userRole) userRole.textContent = data.role === "admin" ? "Admin" : "Member";
		if (userAlias) userAlias.value = data.alias || "";
		if (userButton) {
			const name = displayName(data);
			userButton.title = `${data.role === "admin" ? "Admin" : "Member"}\n${name}\n${data.email}`;
			userButton.textContent = "";
			if (data.picture) {
				const img = document.createElement("img");
				img.className = "avatar-img";
				img.src = data.picture;
				img.alt = "";
				img.referrerPolicy = "no-referrer";
				img.decoding = "async";
				userButton.appendChild(img);
			} else {
				const fallback = document.createElement("span");
				fallback.className = "avatar-fallback";
				fallback.textContent = displayName(data).charAt(0).toUpperCase();
				userButton.appendChild(fallback);
			}
		}
	}

	applySignedOutState();
	if (currentUser) {
		applySignedInState(currentUser);
	} else {
		fetch("/api/me")
			.then((response) => {
				if (!response.ok) throw new Error("Not authenticated");
				return response.json();
			})
			.then((data) => {
				applySignedInState(data);
			})
			.catch(() => {
				applySignedOutState();
			});
	}

	document.addEventListener("click", (event) => {
		const target = event.target;
		if (!(target instanceof HTMLElement)) return;
		if (target.closest(".user-button") && userModal) {
			userModal.showModal();
		}
		if (target.closest("[data-action='close-user']") && userModal) {
			if (userModalError) {
				userModalError.textContent = "";
				userModalError.classList.add("hidden");
			}
			userModal.close();
		}
		if (target.closest(".auth-signout")) {
			fetch("/api/auth/logout", { method: "POST" }).then(() => {
				window.location.href = "/";
			});
		}
	});

	if (userModal) {
		userModal.addEventListener("submit", async (event) => {
			event.preventDefault();
			if (!currentUser) return;
			if (userModalError) {
				userModalError.textContent = "";
				userModalError.classList.add("hidden");
			}
			const response = await fetch("/api/me", {
				method: "PATCH",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ alias: userAlias?.value || "" })
			});
			if (response.ok) {
				if (userModal) userModal.close();
				window.location.reload();
			} else if (userModalError) {
				const message = await response.text();
				userModalError.textContent = message || "Unable to save profile updates.";
				userModalError.classList.remove("hidden");
			}
		});
	}
</script>
